version: 1.0
runtime: python311
build:
  commands:
    build:
      # Verificar Python y pip
      - python --version
      - pip --version

      # Crear directorio para modelos primero
      - mkdir -p src/backend/models || true

      # Actualizar pip con manejo de errores
      - pip install --upgrade pip || exit 1

      # Instalar dependencias base primero (más ligeras)
      - pip install --no-cache-dir flask>=2.0.0 flask-cors>=4.0.0 gunicorn>=21.2.0 || exit 1
      - pip install --no-cache-dir boto3>=1.28.0 python-dotenv>=1.0.0 || exit 1
      - pip install --no-cache-dir numpy>=1.21.0 Pillow>=9.0.0 || exit 1

      # Instalar dependencias de procesamiento de imágenes
      - pip install --no-cache-dir opencv-python-headless>=4.6.0 || exit 1
      - pip install --no-cache-dir scikit-image>=0.19.0 tifffile>=2022.0.0 || exit 1

      # Instalar TensorFlow (más pesado, al final)
      - pip install --no-cache-dir tensorflow>=2.13.0 || exit 1

      # Instalar utilidades finales
      - pip install --no-cache-dir python-json-logger>=2.0.7 || exit 1

      # Verificar instalaciones críticas
      - python -c "import flask; import tensorflow; import cv2; print('Dependencias críticas verificadas')" || exit 1

      # Verificar estructura de directorios
      - ls -la src/backend/ || exit 1
      - test -d src/backend/models || mkdir -p src/backend/models
run:
  runtime-version: 3.11
  command: gunicorn --bind 0.0.0.0:5000 --workers 2 --timeout 120 --access-logfile - --error-logfile - --log-level debug --capture-output src.backend.app:app
  network:
    port: 5000
    env: PORT
  env:
    - name: PORT
      value: "5000"
    - name: HOST
      value: "0.0.0.0"
    - name: PYTHONUNBUFFERED
      value: "1"
    - name: LOG_LEVEL
      value: "DEBUG"
    - name: PYTHONPATH
      value: "."
